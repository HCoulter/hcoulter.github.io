<!DOCTYPE html>
<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111933116-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-111933116-1');
    </script>
    <meta charset="utf-8" />

    <title>Naughty</title>

    <link rel="apple-touch-icon" sizes="57x57" href="./favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="./favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.33.1/sweetalert2.min.css"
        integrity="sha256-/PVkO2+mUlKqE6wgKVXU5Wh4mx3vncHAxLEdpXrziGo=" crossorigin="anonymous" />

    <link rel="stylesheet" href="./css/main.css">

    <!-- Get jQuery JS from Google CDN, or fallback to local copy -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
        window.jQuery || document.write('<script type="text/javascript" src="js/external/jquery-3.2.1.min.js\"><\/script>');
    </script>

    <!-- Get jQuery UI JS from Google CDN, or fallback to local copy -->
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript">
        window.jQuery.ui || document.write('<script type="text/javascript" src="js/external/jquery-ui.min.js\"><\/script>');
    </script>

    <!-- Get Bootstrap JS from Bootstrap CDN, or fallback to local copy -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
    <script>
        window.jQuery.fn.modal || document.write('<script type="text/javascript" src="js/external/bootstrap.min.js\"><\/script>');
    </script>

    <!-- Get Leaflet JS from CDNJS, or fallback to local copy -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"
        integrity="sha256-kdEnCVOWosn3TNsGslxB8ffuKdrZoGQdIdPwh7W1CsE=" crossorigin="anonymous"></script>
    <script>
        window.L || document.write('<script type="text/javascript" src="js/external/leaflet.js\"><\/script>');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.33.1/sweetalert2.js"
        integrity="sha256-u74zWXS2T+G4E4NsM/R8gR8SaTJcq5a0TCks5m+AN9k=" crossorigin="anonymous"></script>

    <!-- Authentication overlay styles and script. The app module will be loaded after successful login. -->
    <style>
        .auth-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1050}
        .auth-card{background:#fff;padding:24px;border-radius:6px;max-width:420px;width:90%;box-shadow:0 6px 18px rgba(0,0,0,.3);text-align:left}
        .auth-card h3{margin-top:0;margin-bottom:12px}
        .auth-card .form-group{margin-bottom:12px}
        #auth-error{min-height:18px}
        .top-auth-bar{position:fixed;top:0;left:0;right:0;height:44px;background:#222;color:#fff;display:flex;align-items:center;justify-content:flex-end;padding:0 12px;z-index:1040}
        .top-auth-bar .btn{margin-left:8px}
        body { padding-top: 44px; }
        /* Sessions sidebar overrides */
        #sessions-panel{position:fixed;top:44px;right:0;bottom:0;width:320px;background:#121212;border-left:1px solid #222;z-index:1045;padding:12px;display:none;overflow-y:auto;box-shadow:-4px 0 12px rgba(0,0,0,0.5)}
        #sessions-panel h4{margin-top:0;margin-bottom:8px;color:#fff}
        #sessions-list .session-entry{background:transparent}
        #sessions-list .session-entry.active{background:#171717;border-left:3px solid #ff5722;padding-left:6px}
        /* Ensure map popups render above sidebar and controls */
        .leaflet-container .leaflet-popup { z-index: 99999 !important; }
        .leaflet-container .leaflet-popup-pane { z-index: 99999 !important; }
        /* Dark theme for leaflet popup wrapper and tip to remove white border */
        .leaflet-container .leaflet-popup-content-wrapper {
            background: #1b1b1b !important;
            color: #fff !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.04) !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6) !important;
        }
        .leaflet-container .leaflet-popup-content {
            background: transparent !important;
            color: #fff !important;
        }
        .leaflet-container .leaflet-popup-tip-container .leaflet-popup-tip {
            background: #1b1b1b !important;
            box-shadow: none !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: #fff !important;
            text-shadow: none !important;
            background: transparent !important;
            border: none !important;
        }
        /* Session popup styling to ensure visibility on dark theme */
        .session-popup { color: #fff !important; background: #1b1b1b !important; padding: 8px; border-radius: 6px; }
        .session-popup .tab-panel { font-size: 13px; color: #fff !important; background: transparent !important; }
    </style>

    <style>
        /* OSRS-like skills grid for session popup */
        .skills-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .skill-box{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;background:linear-gradient(180deg,#2b2b20, #191710);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);color:#fff;border:1px solid rgba(0,0,0,0.6)}
        .skill-icon{width:36px;height:36px;border-radius:4px;background:#2b2b2b;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:12px;border:1px solid rgba(255,255,255,0.04);flex:0 0 36px}
        .skill-icon img{width:28px;height:28px;display:block}
        .skill-meta{flex:1;display:flex;flex-direction:column}
        .skill-name{font-size:12px;color:#e6e6e6}
        .skill-level{font-size:12px;color:#ffd27f;font-weight:700}
        /* Removed progress bar - simpler OSRS style */
        .skills-total{margin-top:8px;text-align:center;font-weight:700;color:#ffd27f;padding:6px 0}
        @media (max-width:600px){ .skills-grid{grid-template-columns:repeat(2,1fr)} }
    </style>
    <style>
        /* Inventory grid styling */
        .items-grid{display:grid;grid-template-columns:repeat(6,44px);gap:6px;justify-content:start}
        .item-box{width:44px;height:44px;border-radius:4px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;position:relative}
        .item-icon img{width:36px;height:36px;display:block}
        .item-qty{position:absolute;right:2px;bottom:2px;background:rgba(0,0,0,0.6);color:#fff;padding:1px 4px;border-radius:3px;font-size:11px}
    </style>

    <script>
        (function(){
            const TOKEN_KEY = 'jwtToken';

            function parseJwt(token){
                try{
                    const parts = token.split('.');
                    if(parts.length !== 3) return null;
                    const payload = parts[1].replace(/-/g,'+').replace(/_/g,'/');
                    const json = atob(payload);
                    return JSON.parse(decodeURIComponent(escape(json)));
                }catch(e){ return null; }
            }

            function tokenValid(token){
                const p = parseJwt(token);
                if(!p || !p.exp) return false;
                return (p.exp * 1000) > Date.now();
            }

            async function login(apiKey){
                try{
                    const res = await fetch(localStorage.getItem('apiHost') + '/api/auth/token/admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey: apiKey })
                    });
                    if(!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if(data && data.token){
                        console.log('Login successful, token received: ' + data.token);
                        localStorage.setItem(TOKEN_KEY, data.token);
                        return true;
                    }
                    return false;
                }catch(e){
                    console.error('Login error', e);
                    return false;
                }
            }

            function showOverlay(){
                const el = document.getElementById('auth-overlay'); if(el) el.style.display = 'flex';
                hideTopBar();
            }
            function hideOverlay(){
                const el = document.getElementById('auth-overlay'); if(el) el.style.display = 'none';
            }

            function showTopBar(){ const el = document.getElementById('top-auth-bar'); if(el) el.style.display = 'flex'; }
            function hideTopBar(){ const el = document.getElementById('top-auth-bar'); if(el) el.style.display = 'none'; }

            function loadApp(){
                const s = document.createElement('script');
                s.type = 'module';
                s.src = '/js/map.js';
                document.head.appendChild(s);
            }

            document.addEventListener('DOMContentLoaded', ()=>{
                const token = localStorage.getItem(TOKEN_KEY);
                const form = document.getElementById('auth-form');
                const hostInput = document.getElementById('server-host');
                const keyInput = document.getElementById('apiKey');
                const errorEl = document.getElementById('auth-error');
                const clearBtn = document.getElementById('auth-clear');

                if(token && tokenValid(token)){
                    hideOverlay();
                    showTopBar();
                    loadApp();
                    return;
                }

                showOverlay();

                form.addEventListener('submit', async (ev)=>{
                    ev.preventDefault();

                    if (!form) return;

                    const host = hostInput.value.trim().replace(/\/$/, '');
                    const apiKey = keyInput.value.trim();

                    if (!host || !apiKey) {
                      errorEl.textContent = 'Server host and API key are required';
                      return;
                    }

                    localStorage.setItem('apiHost', host);
                    document.getElementById('auth-submit').disabled = true;
                    errorEl.textContent = '';
                    const ok = await login(apiKey);
                    document.getElementById('auth-submit').disabled = false;
                    if(ok){ hideOverlay(); showTopBar(); loadApp(); }
                    else { document.getElementById('auth-error').textContent = 'Login failed â€” check API key and server.'; }
                });

                document.getElementById('auth-clear').addEventListener('click', ()=>{
                    localStorage.removeItem(TOKEN_KEY);
                    errorEl.textContent = 'Token cleared. Enter a new API key.';
                    showOverlay();
                });

                const logoutBtn = document.getElementById('top-logout');
                if(logoutBtn){
                    logoutBtn.addEventListener('click', ()=>{
                        localStorage.removeItem(TOKEN_KEY);
                        showOverlay();
                    });
                }
            });

            window.getJwtToken = function(){ return localStorage.getItem(TOKEN_KEY); };
        })();
    </script>
    <script src="/js/auth.js"></script>
    <script src="/js/sessions.js" defer></script>
</head>

<body>
    <div id="top-auth-bar" class="top-auth-bar" style="display:none">
        <span style="flex:1;">Signed in</span>
        <button id="toggle-sessions" class="btn btn-xs btn-info">Sessions</button>
        <button id="top-logout" class="btn btn-xs btn-warning">Logout</button>
    </div>
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-card">
            <h3>Sign in</h3>
            <form id="auth-form">
                <div class="form-group">
                    <input
                      id="server-host"
                      type="text"
                      class="form-control"
                      placeholder="https://localhost:8080"
                      required
                    />
                    <input id="apiKey" type="text" class="form-control" placeholder="API Key" required autofocus>
                </div>
                <div class="form-group">
                    <button id="auth-submit" type="submit" class="btn btn-primary">Login</button>
                    <button id="auth-clear" type="button" class="btn btn-default">Clear token</button>
                </div>
                <div id="auth-error" style="color:#d9534f"></div>
            </form>
        </div>
    </div>

    <div class="container-fluid" id="container">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="map-container">
            <div id="map"></div>
        </div>
        <div class="slide-panel" id="code-output-panel">
            <pre id="code-output-pre"><code id="code-output" contenteditable="true"></code></pre>
        </div>
        <div class="slide-panel" id="settings-panel">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="control-label col-lg-6" for="output-type">Output type</label>
                    <div class="col-lg-5">
                        <select class="form-control" id="output-type">
                            <option>Array</option>
                            <option>List</option>
                            <option>Arrays.asList</option>
                            <option>Raw</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-lg-6" for="bot-api">Bot type</label>
                    <div class="col-lg-5">
                        <select class="form-control" id="bot-api">
                            <option>OSBot</option>
                            <option>TRiBot</option>
                            <option>DreamBot</option>
                            <option>RSPeer</option>
                            <option>QuantumBot</option>
                            <option>RuneMate</option>
                            <option>RuneLite</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-lg-6" for="dax-spacing">Dax Path spacing</label>
                    <div class="col-lg-5">
                        <input id="dax-spacing" class="form-control" type="number" min="0" value="0">
                    </div>
                </div>
            </form>
        </div>
        <div class="slide-panel" id="sessions-panel">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px 8px;border-bottom:1px solid #222;margin-bottom:8px">
                <h4 style="margin:0;color:#fff">Active Sessions</h4>
                <div>
                    <button id="refresh-sessions" class="btn btn-xs btn-primary">Refresh</button>
                    <button id="sessions-close" class="btn btn-xs btn-default">Close</button>
                </div>
            </div>
            <div id="sessions-list"></div>
        </div>
    </div>
</body>

</html>